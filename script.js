const categories = [
  {
    title: "Opening Statements",
    type: "sentence",
    coreGroup: "opening",
    statements: [
      "{StudentName} started this year with curiosity and a willingness to try new things.",
      "Throughout the year, they approached challenges with a positive mindset.",
      "I enjoyed working with them during speech therapy sessions this year.",
      "{StudentName} consistently brought energy and kindness to each session.",
      "From our first session, it was clear that they care deeply about learning.",
      "{StudentName} made every session more enjoyable with their personality.",
      "It has been a privilege to support them on communication goals.",
      "Getting to know them was a highlight of my school year.",
      "Watching them interact with peers showed growth in confidence.",
      "Each session with them was filled with effort and growth.",
      "This year truly helped them grow.",
      "{StudentName} approached each session with enthusiasm and curiosity.",
      "{StudentName} showed genuine interest in connecting with others.",
      "Their positive attitude set the tone for our work together.",
      "From the start, they impressed me with their determination.",
      "{StudentName} brought a sense of fun and openness to learning.",
      "Watching them grow has been inspiring.",
      "{StudentName} always greeted me with a smile, ready to participate.",
      "{StudentName} quickly built positive relationships with peers and adults.",
      "Their willingness to try new strategies stood out all year.",
      "{StudentName} made each day brighter for our group."
    ]


  },
  {
    title: "Strengths & Positive Attributes",
    type: "sentence",
    coreGroup: "strengths",
    statements: [
      "{StudentName} is kind to peers and helps others feel included.",
      "They ask thoughtful questions and listen with care.",
      "They respond well to encouragement and try new strategies.",
      "Patience and flexibility are among their strengths.",
      "They bring creative ideas to conversations and activities.",
      "I appreciate their ability to stay focused during tasks.",
      "They notice when classmates need help and offer support.",
      "Curiosity drives them to explore new topics in speech.",
      "They are developing strong self-advocacy skills.",
      "Humor and warmth make them a joy to work with.",
      "They collaborate well in group activities.",
      "They use respectful communication with both adults and peers.",
      "Empathy is a core part of how they interact with others.",
      "I notice their confidence increasing as skills improve.",
      "They show pride in progress and celebrate achievements.",
      "{StudentName} left a positive impression on everyone.",
      "They show strong leadership qualities among peers.",
      "They bring a unique perspective to our conversations.",
      "Their resilience is evident when facing new tasks.",
      "They adapt to change with a positive outlook.",
      "They demonstrate integrity in daily interactions.",
      "They are quick to offer a helping hand when needed.",
      "Creativity and curiosity drive them to explore and learn.",
      "Their sense of humor lifts the group spirit.",
      "They model respectful behavior for classmates.",
      "They are eager to learn from feedback and grow."
    ]


  },
  
    {
      title: "Speech & Language Progress",
      coreGroup: "progress",
      type: "list",
      statements: [
        "Improved accuracy with target speech sounds.",
        "Uses new words and phrases to share ideas.",
        "Participates in group discussions with increased confidence.",
        "Follows multi-step directions with less support.",
        "Asks and answers questions during lessons.",
        "Uses clear speech with classmates.",
        "Practices communication skills outside of therapy.",
        "Understands and uses figurative language.",
        "Repairs misunderstandings using learned strategies.",
        "Organizes thoughts before speaking.",
        "Recognizes and names emotions during activities.",
        "Advocates for communication needs when necessary.",
        "Shares stories and information with greater detail.",
        "Applies learned strategies in new settings.",
        "Uses visuals or AAC to support communication.",
        "Makes meaningful progress throughout the year.",
        "Expresses ideas more fluently in conversations.",
        "Demonstrates comfort asking for help when needed.",
        "Expands vocabulary every week.",
        "Takes pride in sharing new words and concepts.",
        "Demonstrates improved listening and response skills.",
        "Builds on feedback to refine communication.",
        "Describes events and experiences with more detail.",
        "Works hard to apply learned strategies across settings.",
        "Shows increased participation in class discussions.",
        "Approaches communication challenges with persistence."
      ]
    
    

  },
  {
    title: "Transition Suggestions",
    type: "sentence",
    coreGroup: "transition",
    statements: [
      "Consistent routines will help with the transition to a new setting.",
      "Visual schedules and written reminders may support {him/her/them} during transitions.",
      "Pairing {him/her/them} with a peer buddy can encourage social confidence.",
      "Opportunities for small-group work will benefit {his/her/their} learning.",
      "Previewing changes before they happen helps {him/her/them} feel prepared.",
      "Extra time for processing directions supports {his/her/their} independence.",
      "Encouragement and positive feedback build {his/her/their} self-esteem.",
      "Speech and language supports should continue as needed.",
      "Regular adult check-ins help {him/her/them} navigate new routines.",
      "Clear expectations and structured environments set {him/her/them} up for success.",
      "Encouraging {him/her/them} to reflect on growth will support future progress.",
      "Opportunities for choice increase {his/her/their} engagement.",
      "Safe spaces and calming strategies help {him/her/them} regulate emotions.",
      "Involving families in communication planning is important for {his/her/their} success.",
      "Celebrating small wins keeps {him/her/them} motivated.",
      "They have demonstrated an ability to take on new challenges with confidence.",
      "Familiar routines will ease {his/her/their} adjustment to a new environment.",
      "Advanced notice of changes supports {him/her/them} in adapting smoothly.",
      "Opportunities to make choices help {him/her/them} feel empowered.",
      "Check-ins at the start and end of the day promote confidence.",
      "Small group support will reinforce communication growth.",
      "Using visual cues can help {him/her/them} understand expectations.",
      "Time to process new information will benefit {his/her/their} learning.",
      "Collaboration between home and school supports a smooth transition.",
      "Opportunities to share successes will motivate {him/her/them}.",
      "A patient, encouraging approach will help {StudentName} thrive.",
      "Visual cues such as pictures or schedules support smooth transitions.",
      "Verbal reminders prepare for changes in activities or routines.",
      "Step-by-step instructions increase understanding during new or complex transitions.",
      "Gentle physical cues, like tapping a desk or pointing, signal when it’s time to transition.",
      "Previewing the next activity reduces anxiety and increases readiness.",
      "Checklists or 'first-then' boards provide structure for moving between tasks.",
      "Timers or countdowns offer clear expectations for when transitions will occur.",
      "Pairing verbal and visual cues increases independence during transitions.",
      "Nonverbal signals such as a hand gesture or bell sound support timely movement between activities.",
      "Written instructions or checklists serve as reminders for multi-step transitions.",
      "Offering choices about the order of tasks supports engagement during transitions.",
      "Gradual reduction of cueing over time may promote independence.",
      "Cue cards or 'transition tokens' make changes predictable and positive.",
      "Using consistent language and routines helps internalize transition cues.",
      "Adult modeling and practice opportunities increase success with less support."
    ]
  },
  {
    title: "Closing Statements",
    type: "sentence",
    coreGroup: "closing",
    statements: [
      "I am excited to see what {StudentName} will accomplish next year.",
      "I look forward to hearing about {his/her/their} future successes.",
      "Wishing {him/her/them} all the best in the coming year.",
      "Please stay in touch if you have questions or need support.",
      "I am grateful to have been part of {his/her/their} journey.",
      "Thank you for sharing {him/her/them} with our school community.",
      "This is not goodbye—just the start of a new adventure for {him/her/them}.",
      "Thank you for making this year so meaningful.",
      "I am so proud of {his/her/their} achievements.",
      "I wish {him/her/them} continued happiness and growth.",
      "It has been an honor to support {him/her/them} this year.",
      "Here’s to new adventures and more success ahead.",
      "Stay curious and keep learning, {StudentName}!",
    ]
  },
  {
    title: "Receptive Language",
    goal: "receptive",
    type: "list",
    statements: [
      "Follows multi-step directions with improved independence.",
      "Understands and responds to a wider range of questions.",
      "Identifies key details in stories or classroom discussions.",
      "Comprehends new vocabulary words in context.",
      "Demonstrates understanding of basic and complex concepts.",
      "Recognizes and interprets figurative language and idioms.",
      "Understands classroom routines and transitions more easily.",
      "Shows growth in listening comprehension during group activities.",
      "Follows directions with fewer repetitions or cues.",
      "Asks for clarification when unsure, supporting self-advocacy.",
      "Understands instructions with greater accuracy.",
      "Follows classroom conversations with increased ease.",
      "Identifies main ideas and details when listening.",
      "Responds to both literal and inferential questions.",
      "Shows improved comprehension of group instructions.",
      "Recognizes when to ask for more information.",
      "Shows progress in understanding abstract language.",
      "Uses context clues to interpret unfamiliar information.",
      "Processes auditory information with greater skill.",
      "Demonstrates self-advocacy by seeking clarification."
    ]


  },
  {
    title: "Expressive Language",
    goal: "expressive",
    type: "list",
    statements: [
      "Uses more complete and detailed sentences when speaking.",
      "Retells stories and events with greater organization.",
      "Selects and uses precise vocabulary to express ideas.",
      "Describes personal experiences and classroom topics clearly.",
      "Answers open-ended questions with expanded responses.",
      "Asks questions to learn more or clarify information.",
      "Uses transition words to connect ideas in speech.",
      "Produces grammatically correct sentences more consistently.",
      "Shares ideas in group discussions with increased confidence.",
      "Demonstrates progress in expressive language across settings.",
      "Shares ideas using complete sentences.",
      "Expresses thoughts clearly in classroom discussions.",
      "Tells stories with more detail and organization.",
      "Asks and answers questions confidently.",
      "Explains reasoning behind answers more fully.",
      "Adapts language for different audiences.",
      "Uses vocabulary that is precise and varied.",
      "Uses language to solve problems and negotiate.",
      "Connects ideas logically in speech.",
      "Takes more risks with expressive language."
    ]


  },
  {
    title: "Articulation",
    goal: "articulation",
    type: "list",
    statements: [
      "Produces target sounds accurately in structured tasks.",
      "Uses clear speech during classroom activities.",
      "Self-corrects speech errors with minimal prompting.",
      "Generalizes correct sound production to conversations.",
      "Demonstrates increased awareness of speech sound placement.",
      "Applies strategies to improve overall intelligibility.",
      "Produces sounds accurately in longer sentences.",
      "Recognizes and repairs communication breakdowns related to speech.",
      "Maintains speech clarity across various settings.",
      "Shows pride in progress in articulation skills.",
      "Produces target sounds accurately in reading tasks.",
      "Applies correct articulation to unfamiliar words.",
      "Shows improved speech clarity in spontaneous conversation.",
      "Uses strategies to correct speech errors independently.",
      "Demonstrates increased confidence in speaking.",
      "Explains and models correct sound placement.",
      "Shows increased awareness of sound errors.",
      "Seeks feedback and self-monitors speech production.",
      "Practices new sounds with diligence.",
      "Consistently applies skills in both therapy and class."
    ]

  },
  {
    title: "AAC",
    goal: "aac",
    type: "list",
    statements: [
      "Communicates wants and needs with greater independence using AAC.",
      "Navigates the AAC device to find words and phrases.",
      "Initiates communication during group activities.",
      "Combines symbols or words to create sentences.",
      "Requests help or clarification using the device.",
      "Repairs breakdowns by adjusting messages.",
      "Explores new vocabulary on the AAC system.",
      "Uses AAC in both structured and unstructured settings.",
      "Responds to questions using AAC with less support.",
      "Develops confidence as an AAC communicator.",
      "Selects messages on the AAC device independently.",
      "Participates in classroom routines using AAC.",
      "Shows willingness to explore new features.",
      "Responds to peer communication with AAC.",
      "Combines multiple words or symbols for complex messages.",
      "Initiates communication for a variety of purposes.",
      "Demonstrates increased confidence in using AAC.",
      "Personalizes messages to suit specific situations.",
      "Uses AAC successfully across different environments.",
      "Shares preferences and choices through AAC."
    ]

  },
  {
    title: "Social/Pragmatic",
    goal: "social",
    type: "list",
    statements: [
      "Greets peers and adults appropriately.",
      "Uses eye contact and body language in conversation.",
      "Takes turns and listens during group discussions.",
      "Asks and answers questions in social situations.",
      "Recognizes and responds to nonverbal cues.",
      "Joins group activities and play with increasing confidence.",
      "Uses strategies to resolve conflicts with peers.",
      "Maintains topics and makes relevant comments.",
      "Shows empathy and understanding in interactions.",
      "Applies social communication skills across settings.",
      "Uses greetings and farewells more consistently.",
      "Starts and maintains conversations with peers.",
      "Shows improved understanding of conversational turn-taking.",
      "Recognizes emotions in others and responds appropriately.",
      "Manages disagreements respectfully.",
      "Joins peer activities with greater ease.",
      "Demonstrates growth in nonverbal communication skills.",
      "Maintains eye contact and appropriate personal space.",
      "Adapts communication for different settings.",
      "Demonstrates flexibility in group interactions."
    ]
  },
  {
    title: "Fluency",
    goal: "fluency",
    type: "list",
    statements: [
      "Demonstrates increased awareness of smooth and bumpy speech.",
      "Uses strategies to manage moments of stuttering.",
      "Pauses and phrases sentences to improve fluency.",
      "Maintains eye contact and communicates effectively during disfluencies.",
      "Uses self-advocacy skills to communicate about speech needs.",
      "Identifies and describes feelings about speech in different situations.",
      "Practices easy onset and light contact techniques in conversation.",
      "Uses slow, controlled speech in structured activities.",
      "Recovers from disfluencies and continues communication.",
      "Participates in classroom discussions with increased confidence.",
      "Describes strategies used to improve speech fluency.",
      "Monitors rate of speech and adjusts as needed.",
      "Shares thoughts and ideas even when moments of stuttering occur.",
      "Communicates needs and preferences regarding speech supports.",
      "Demonstrates willingness to try new fluency techniques.",
      "Uses positive self-talk and coping strategies during speech challenges.",
      "Engages in role-plays or group activities to practice fluent speech.",
      "Shows persistence and resilience in working on fluency skills.",
      "Celebrates progress in managing speech fluency.",
      "Generalizes fluency strategies to new settings and situations."
    ]
  },
  {
    title: "Literacy & Phonological Awareness",
    goal: "literacy",
    type: "list",
    statements: [
      "Identifies letter-sound relationships in new and familiar words.",
      "Blends individual sounds to form complete words.",
      "Segments words into individual sounds and syllables.",
      "Recognizes and produces rhyming words.",
      "Demonstrates understanding of beginning, middle, and ending sounds.",
      "Participates in phonological awareness activities with confidence.",
      "Applies phonics knowledge to decode new words.",
      "Reads grade-level sight words accurately.",
      "Uses context clues to understand new vocabulary.",
      "Demonstrates growth in reading fluency and comprehension.",
      "Spells words by listening to and segmenting sounds.",
      "Matches written and spoken words during reading tasks.",
      "Identifies words that start or end with the same sound.",
      "Sorts and categorizes words based on sound patterns.",
      "Uses decoding strategies to tackle challenging words.",
      "Recognizes patterns in word families and spelling.",
      "Asks for help or clarification when unsure about reading or spelling.",
      "Shows confidence in sharing ideas during reading activities.",
      "Participates actively in group reading or literacy games.",
      "Demonstrates progress in phonological awareness skills across settings."
    ]
  },
  {
    title: "Attention & Listening",
    goal: "attention",
    type: "list",
    statements: [
      "Maintains attention to task for increasing periods.",
      "Responds to name or cues for attention promptly.",
      "Demonstrates active listening by making eye contact and responding.",
      "Uses strategies (e.g., fidgets, breaks) to support attention.",
      "Participates in joint attention activities with peers or adults.",
      "Remains engaged during group activities and lessons.",
      "Recovers focus after distractions independently.",
      "Follows classroom routines by attending to visual or verbal cues.",
      "Completes multi-step directions by maintaining focus.",
      "Self-monitors attention and asks for help as needed."
    ]
  }
  
  
  
];



// ====== Your Categories Array (leave unchanged from your commit) ======
// ... (your full categories array here; I left it out for brevity)

// ====== Pronoun Map ======
const pronounMap = {
  she: { sub: "she", obj: "her", poss: "her", refl: "herself" },
  he: { sub: "he", obj: "him", poss: "his", refl: "himself" },
  they: { sub: "they", obj: "them", poss: "their", refl: "themself" }
};

const anecdotePrompts = [
  "Describe a positive, memorable, or unique moment that stood out this year.",
  "Share a breakthrough or milestone moment during therapy.",
  "Describe something {StudentName} said or did that surprised you.",
  "Write about a time {StudentName} made someone laugh or smile.",
  "Reflect on a challenge {StudentName} overcame this year."
];

const badge = document.getElementById('no-cookie-badge');
const modal = document.getElementById('disclaimer-modal');
const close = modal.querySelector('.modal-close');

badge.addEventListener('click', () => modal.classList.add('open'));
close.addEventListener('click', () => modal.classList.remove('open'));


function smartReplace(sentence, idx, total, name, pronounSet, pronounMapObj) {
  // For they/them, use name for first and last, plural they/them for middle
  if (pronounSet === "they") {
    if (idx === 0 || idx === total - 1) {
      return sentence
        .replace(/{StudentName}/g, name)
        .replace(/{he\/she\/they}/gi, name)
        .replace(/{him\/her\/them}/gi, name)
        .replace(/{his\/her\/their}/gi, name + "'s")
        .replace(/{himself\/herself\/themself}/gi, name);
    } else {
      // PLURAL pronouns/verbs only! Make sure templates use plural!
      return sentence
        .replace(/{StudentName}/g, pronounMapObj.sub.charAt(0).toUpperCase() + pronounMapObj.sub.slice(1)) // "They"
        .replace(/{he\/she\/they}/gi, pronounMapObj.sub)
        .replace(/{him\/her\/them}/gi, pronounMapObj.obj)
        .replace(/{his\/her\/their}/gi, pronounMapObj.poss)
        .replace(/{himself\/herself\/themself}/gi, pronounMapObj.refl);
    }
  } else {
    // he/she logic
    if (idx === 0 || idx === total - 1) {
      return sentence
        .replace(/{StudentName}/g, name)
        .replace(/{He\/She\/They}'s/gi, capitalize(pronounMapObj.poss))
        .replace(/{he\/she\/they}'s/gi, pronounMapObj.poss)
        .replace(/{he\/she\/they}/gi, pronounMapObj.sub)
        .replace(/{him\/her\/them}/gi, pronounMapObj.obj)
        .replace(/{his\/her\/their}/gi, pronounMapObj.poss)
        .replace(/{himself\/herself\/themself}/gi, pronounMapObj.refl);
    } else {
      return sentence
        .replace(/{StudentName}/g, pronounMapObj.sub.charAt(0).toUpperCase() + pronounMapObj.sub.slice(1))
        .replace(/{He\/She\/They}'s/gi, capitalize(pronounMapObj.poss))
        .replace(/{he\/she\/they}'s/gi, pronounMapObj.poss)
        .replace(/{he\/she\/they}/gi, pronounMapObj.sub)
        .replace(/{him\/her\/them}/gi, pronounMapObj.obj)
        .replace(/{his\/her\/their}/gi, pronounMapObj.poss)
        .replace(/{himself\/herself\/themself}/gi, pronounMapObj.refl);
    }
  }
}

function capitalizeSentences(text) {
  // Capitalize the first letter of the whole text
  text = text.charAt(0).toUpperCase() + text.slice(1);
  // Then capitalize after sentence-ending punctuation + space(s)
  return text.replace(/([.?!]\s+)([a-z])/g, function (match, p1, p2) {
    return p1 + p2.toUpperCase();
  });
}

function capitalizeFirst(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// ====== Global for Section Order ======
window.orderedCategories = [];

// ====== Anecdote Prompt Renderer ======
function renderAnecdotePrompt(studentName = "{StudentName}") {
  const select = document.getElementById("anecdotePrompt");
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = "";
  anecdotePrompts.forEach(template => {
    const option = document.createElement("option");
    option.value = template.replace(/{StudentName}/g, studentName || "{StudentName}");
    option.textContent = template.replace(/{StudentName}/g, studentName || "{StudentName}");
    if (option.value === currentValue) option.selected = true;
    select.appendChild(option);
  });
}

// ====== Capitalization Helper ======
function capitalize(word) {
  return word.charAt(0).toUpperCase() + word.slice(1);
}

// ====== Render Sections ======
function renderSections(studentName = "{StudentName}", pronounSet = "she") {
  const p = pronounMap[pronounSet];
  const container = document.getElementById("sections");

  // Track selected templates before rerender
  const previouslySelected = {};
  document.querySelectorAll(".section").forEach(section => {
    Array.from(section.querySelectorAll(".button.selected")).forEach(btn => {
      previouslySelected[btn.dataset.orig] = true;
    });
  });

  container.innerHTML = "";

  // --- FILTERING AND ORDERING ---
  const activeGoals = Array.from(document.querySelectorAll('#goalAreaChooser input[type="checkbox"]:checked')).map(cb => cb.value);

  const coreBeforeGoals = categories.filter(cat => !cat.goal && (
    !cat.coreGroup ||
    cat.coreGroup === "opening" ||
    cat.coreGroup === "strengths" ||
    cat.coreGroup === "progress"
  ));

  const goalCategories = categories.filter(cat => cat.goal && activeGoals.includes(cat.goal));
  const coreAfterGoals = categories.filter(cat => !cat.goal && cat.coreGroup && (
    cat.coreGroup === "transition" ||
    cat.coreGroup === "closing"
  ));

  // ✅ Define order AFTER arrays are built!
  window.orderedCategories = [...coreBeforeGoals, ...goalCategories, ...coreAfterGoals];

  window.orderedCategories.forEach((cat, i) => {
    const section = document.createElement("div");
    section.classList.add("section");
    section.dataset.index = i;

    const header = document.createElement("h2");
    header.innerHTML = `${section.classList.contains("open") ? '▼' : '▸'} ${cat.title} <span class="badge"></span>`;
    header.addEventListener("click", () => {
      section.classList.toggle("open");
      header.innerHTML = `${section.classList.contains("open") ? '▼' : '▸'} ${cat.title} <span class="badge"></span>`;
      updateBadges();
    });

    const content = document.createElement("div");
    content.classList.add("section-content");

    cat.statements.forEach((text) => {
      const btn = document.createElement("button");
      btn.className = "button";
      btn.type = "button";
      btn.dataset.orig = text;
      btn.textContent = capitalizeFirst(
        text
          .replace(/{StudentName}/g, studentName || "{StudentName}")
          .replace(/{He\/She\/They}'s/gi, capitalize(p.poss))
          .replace(/{he\/she\/they}'s/gi, p.poss)
          .replace(/{he\/she\/they}/gi, m => m[1] === 'H' ? capitalize(p.sub) : p.sub)
          .replace(/{him\/her\/them}/gi, m => m[1] === 'H' ? capitalize(p.obj) : p.obj)
          .replace(/{his\/her\/their}/gi, m => m[1] === 'H' ? capitalize(p.poss) : p.poss)
          .replace(/{himself\/herself\/themself}/gi, m => m[1] === 'H' ? capitalize(p.refl) : p.refl)
          // Possessive correction for any missed
          .replace(/\b[Ss]he's\s/g, (m) => m[0] === "S" ? "Her " : "her ")
          .replace(/\b[Hh]e's\s/g, (m) => m[0] === "H" ? "His " : "his ")
          .replace(/\b[Tt]hey's\s/g, (m) => m[0] === "T" ? "Their " : "their ")
      );
      if (previouslySelected[text]) btn.classList.add("selected");
      btn.addEventListener("click", () => {
        btn.classList.toggle("selected");
        updatePreview();
        updateBadges();
      });
      content.appendChild(btn);
    });

    section.appendChild(header);
    section.appendChild(content);
    container.appendChild(section);
  });

  updateBadges();
  renderAnecdotePrompt(studentName);
}

// ====== Preview Renderer ======
function updatePreview() {
  const name = document.getElementById("studentName").value.trim() || "{StudentName}";
  const pronounSet = document.getElementById("pronouns").value;
  const p = pronounMap[pronounSet];
  let letter = "";

  function replacePronouns(str, useName = false) {
    const name = document.getElementById("studentName").value.trim() || "{StudentName}";
    const pronounSet = document.getElementById("pronouns").value;
    const p = pronounMap[pronounSet];

    // If 'they/them' is selected, always use student's name for all pronoun placeholders
    if (pronounSet === "they") {
      return str
        .replace(/{StudentName}/g, name)
        .replace(/{He\/She\/They}'s/gi, name + "'s")
        .replace(/{he\/she\/they}'s/gi, name + "'s")
        .replace(/{he\/she\/they}/gi, name)
        .replace(/{him\/her\/them}/gi, name)
        .replace(/{his\/her\/their}/gi, name + "'s")
        .replace(/{himself\/herself\/themself}/gi, name);
    }

    // Otherwise, normal replacement logic
    return str
      .replace(/{StudentName}/g, useName ? name : p.sub)
      .replace(/{He\/She\/They}'s/gi, capitalize(p.poss))
      .replace(/{he\/she\/they}'s/gi, p.poss)
      .replace(/{he\/she\/they}/gi, m => m[1] === 'H' ? capitalize(p.sub) : p.sub)
      .replace(/{him\/her\/them}/gi, m => m[1] === 'H' ? capitalize(p.obj) : p.obj)
      .replace(/{his\/her\/their}/gi, m => m[1] === 'H' ? capitalize(p.poss) : p.poss)
      .replace(/{himself\/herself\/themself}/gi, m => m[1] === 'H' ? capitalize(p.refl) : p.refl);
  }


  (window.orderedCategories || []).forEach((cat, i) => {
    const section = document.querySelector(`.section[data-index='${i}']`);
    if (!section) return;
    const selectedBtns = Array.from(section.querySelectorAll('.button.selected'));
    const selected = selectedBtns.map(btn => btn.dataset.orig);

    if (!selected.length) return;

    if (cat.type === "list") {
      letter += cat.title + ":\n";
      selected.forEach((s, idx) => {
        let replaced;
        if (selected.length === 1 || idx === 0 || idx === selected.length - 1) {
          replaced = replacePronouns(s, true);
        } else {
          replaced = replacePronouns(s, false);
        }
        letter += "• " + replaced + "\n";
      });
      letter += "\n";
    } else {
      const name = document.getElementById("studentName").value.trim() || "{StudentName}";
      const pronounSet = document.getElementById("pronouns").value;
      const p = pronounMap[pronounSet];

      let para = "";
      selected.forEach((s, idx) => {
        para += smartReplace(s, idx, selected.length, name, pronounSet, p).trim() + " ";
      });
      letter += capitalizeSentences(para.trim()) + "\n\n";
    }
  });

  const anecdote = document.getElementById("anecdoteText")?.value.trim();
  if (anecdote) {
    letter += anecdote + "\n\n";
  }

  document.getElementById("output").textContent = letter.trim();
}

// ====== Badge Updater ======
function updateBadges() {
  document.querySelectorAll(".section").forEach((section) => {
    const count = section.querySelectorAll(".button.selected").length;
    const badge = section.querySelector(".badge");
    if (badge) {
      badge.textContent = count;
      badge.className = count > 0 ? "badge active" : "badge";
    }
  });
}

// ====== DOM Ready & Events ======
document.addEventListener("DOMContentLoaded", function () {
  function renderAndPreview() {
    renderSections(
      document.getElementById("studentName").value.trim(),
      document.getElementById("pronouns").value
    );
    updatePreview();
  }

  renderAndPreview();
  document.getElementById("studentName").addEventListener("input", renderAndPreview);
  document.getElementById("pronouns").addEventListener("change", renderAndPreview);
  document.querySelectorAll('#goalAreaChooser input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', renderAndPreview);
  });
  document.getElementById("anecdoteText").addEventListener("input", updatePreview);
  document.getElementById("anecdotePrompt").addEventListener("change", (e) => {
    document.getElementById("anecdoteText").placeholder = e.target.value;
  });

  document.getElementById("copyBtn").addEventListener("click", () => {
    const text = document.getElementById("output").textContent;
    navigator.clipboard.writeText(text).then(() => {
      const msg = document.getElementById("copyMsg");
      msg.style.display = "inline";
      setTimeout(() => { msg.style.display = "none"; }, 1200);
    });
  });
});
